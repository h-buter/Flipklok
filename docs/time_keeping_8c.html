<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Flipklok: Code/timeKeeping.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Flipklok
   </div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('time_keeping_8c.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle"><div class="title">timeKeeping.c File Reference</div></div>
</div><!--header-->
<div class="contents">

<p>handles the keeping and calculating of time of the system  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;<a class="el" href="time_keeping_8h_source.html">timeKeeping.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="dcf_receive_8h_source.html">dcfReceive.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="uart_8h_source.html">uart.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="pin_interrupts_8h_source.html">pinInterrupts.h</a>&quot;</code><br />
</div>
<p><a href="time_keeping_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a7abf628b1be576ba88bfc3c94f0bb2c9" id="r_a7abf628b1be576ba88bfc3c94f0bb2c9"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a7abf628b1be576ba88bfc3c94f0bb2c9">calculateTimeDifference</a> ()</td></tr>
<tr class="memdesc:a7abf628b1be576ba88bfc3c94f0bb2c9"><td class="mdescLeft">&#160;</td><td class="mdescRight">calculate the difference between the mechanical time and the current time to have the time difference which the stepper needs to be advanced with, gets called from end interrupt of <a class="el" href="timer_8c.html#a3932b1c16ad3692fa3f29df5266488e0" title="Interrupt vector of timer0 CCR1 till CCR2 and TA0IFG.">ISR_TA0(void)</a>.  <br /></td></tr>
<tr class="separator:a7abf628b1be576ba88bfc3c94f0bb2c9"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab26d0d9b0b8a543f7ddbe92d7672f016" id="r_ab26d0d9b0b8a543f7ddbe92d7672f016"><td class="memItemLeft" align="right" valign="top">uint32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#ab26d0d9b0b8a543f7ddbe92d7672f016">calculateStepsToTake</a> (uint32_t time)</td></tr>
<tr class="memdesc:ab26d0d9b0b8a543f7ddbe92d7672f016"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calculate the steps to take for a given time difference, gets called by <a class="el" href="#a7abf628b1be576ba88bfc3c94f0bb2c9" title="calculate the difference between the mechanical time and the current time to have the time difference...">calculateTimeDifference()</a>  <br /></td></tr>
<tr class="separator:ab26d0d9b0b8a543f7ddbe92d7672f016"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9e802ca49d23153a19ded7154d8d6895" id="r_a9e802ca49d23153a19ded7154d8d6895"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a9e802ca49d23153a19ded7154d8d6895">resetTimeKeeping</a> ()</td></tr>
<tr class="memdesc:a9e802ca49d23153a19ded7154d8d6895"><td class="mdescLeft">&#160;</td><td class="mdescRight">Reset the time settings on startup, gets called from <a class="el" href="main_8c.html#a6288eba0f8e8ad3ab1544ad731eb7667" title="Main function that initializes system components and enters low-power mode.">main()</a>  <br /></td></tr>
<tr class="separator:a9e802ca49d23153a19ded7154d8d6895"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="var-members" name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a6f46f3eac7facdb1783cf2d0992be454" id="r_a6f46f3eac7facdb1783cf2d0992be454"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a6f46f3eac7facdb1783cf2d0992be454">toggleCalculateTimeDifference</a> = 1</td></tr>
<tr class="separator:a6f46f3eac7facdb1783cf2d0992be454"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>handles the keeping and calculating of time of the system </p>

<p class="definition">Definition in file <a class="el" href="time_keeping_8c_source.html">timeKeeping.c</a>.</p>
</div><h2 class="groupheader">Function Documentation</h2>
<a id="ab26d0d9b0b8a543f7ddbe92d7672f016" name="ab26d0d9b0b8a543f7ddbe92d7672f016"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab26d0d9b0b8a543f7ddbe92d7672f016">&#9670;&#160;</a></span>calculateStepsToTake()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint32_t calculateStepsToTake </td>
          <td>(</td>
          <td class="paramtype">uint32_t</td>          <td class="paramname"><span class="paramname"><em>time</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Calculate the steps to take for a given time difference, gets called by <a class="el" href="#a7abf628b1be576ba88bfc3c94f0bb2c9" title="calculate the difference between the mechanical time and the current time to have the time difference...">calculateTimeDifference()</a> </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">time</td><td>the difference between time to advance the stepper with </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>uint32_t amount of steps that the stepper needs to be rotated with </dd></dl>

<p class="definition">Definition at line <a class="el" href="time_keeping_8c_source.html#l00122">122</a> of file <a class="el" href="time_keeping_8c_source.html">timeKeeping.c</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  123</span>{</div>
<div class="line"><span class="lineno">  124</span>    <span class="keywordflow">if</span> (time &lt;= 0) <span class="comment">//time difference is negative or 0</span></div>
<div class="line"><span class="lineno">  125</span>    {</div>
<div class="line"><span class="lineno">  126</span>        __no_operation();</div>
<div class="line"><span class="lineno">  127</span>        <span class="keywordflow">return</span> 0;</div>
<div class="line"><span class="lineno">  128</span>    }</div>
<div class="line"><span class="lineno">  129</span>    <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno">  130</span>    {</div>
<div class="line"><span class="lineno">  131</span>        <span class="keywordtype">double</span> steps = (double)time * <a class="code hl_define" href="time_keeping_8h.html#a43e78fee456e5d6c2f3afd78dcb4f548">stepsClockSecond</a>;</div>
<div class="line"><span class="lineno">  132</span>        uint32_t stepsRounded = (uint32_t)steps;</div>
<div class="line"><span class="lineno">  133</span>        __no_operation();</div>
<div class="line"><span class="lineno">  134</span>        <span class="keywordflow">return</span> stepsRounded;</div>
<div class="line"><span class="lineno">  135</span>    }</div>
<div class="line"><span class="lineno">  136</span>}</div>
<div class="ttc" id="atime_keeping_8h_html_a43e78fee456e5d6c2f3afd78dcb4f548"><div class="ttname"><a href="time_keeping_8h.html#a43e78fee456e5d6c2f3afd78dcb4f548">stepsClockSecond</a></div><div class="ttdeci">#define stepsClockSecond</div><div class="ttdef"><b>Definition</b> <a href="time_keeping_8h_source.html#l00031">timeKeeping.h:31</a></div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="time_keeping_8h_source.html#l00031">stepsClockSecond</a>.</p>

</div>
</div>
<a id="a7abf628b1be576ba88bfc3c94f0bb2c9" name="a7abf628b1be576ba88bfc3c94f0bb2c9"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7abf628b1be576ba88bfc3c94f0bb2c9">&#9670;&#160;</a></span>calculateTimeDifference()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void calculateTimeDifference </td>
          <td>(</td>
          <td class="paramname"><span class="paramname"><em></em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>calculate the difference between the mechanical time and the current time to have the time difference which the stepper needs to be advanced with, gets called from end interrupt of <a class="el" href="timer_8c.html#a3932b1c16ad3692fa3f29df5266488e0" title="Interrupt vector of timer0 CCR1 till CCR2 and TA0IFG.">ISR_TA0(void)</a>. </p>
<p>It then calculates the amount of steps that are needed to advance the clock to display the current time. The function take in to account which way it is the fastest to fully wrap the clock or to wait until the time synchronizes </p>

<p class="definition">Definition at line <a class="el" href="time_keeping_8c_source.html#l00026">26</a> of file <a class="el" href="time_keeping_8c_source.html">timeKeeping.c</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   27</span>{</div>
<div class="line"><span class="lineno">   28</span>    <span class="keywordflow">if</span>(<a class="code hl_variable" href="dcf_receive_8h.html#a5db7e822e50d05412c4701789f4ec79b">countDcf77Messages</a> &gt; 0)</div>
<div class="line"><span class="lineno">   29</span>    {</div>
<div class="line"><span class="lineno">   30</span>        __no_operation();</div>
<div class="line"><span class="lineno">   31</span>        <span class="keyword">volatile</span> <span class="keywordtype">int</span> testing = 0;</div>
<div class="line"><span class="lineno">   32</span>    }</div>
<div class="line"><span class="lineno">   33</span>    <span class="keyword">volatile</span> uint32_t timeDiff;</div>
<div class="line"><span class="lineno">   34</span>    __no_operation();</div>
<div class="line"><span class="lineno">   35</span>    <a class="code hl_variable" href="dcf_receive_8h.html#a909b02a38b5db7138462f28eb808d048">toggleInterruptDcf</a> = 1; <span class="comment">// Enable dcfReceive interrupt</span></div>
<div class="line"><span class="lineno">   36</span><span class="comment">//    unsigned int state = __get_SR_register() &amp; GIE; __disable_interrupt();  // Save current interrupt state and disable interrupts</span></div>
<div class="line"><span class="lineno">   37</span>    <span class="keywordflow">if</span> (0 == <a class="code hl_variable" href="pin_interrupts_8h.html#ab5491185939441dc1d12d58ac2a8ccc2">toggleFwdInterrupt</a>) <span class="comment">//fwdButton is not pressed otherwise skip time keeping</span></div>
<div class="line"><span class="lineno">   38</span>    {</div>
<div class="line"><span class="lineno">   39</span>        <span class="keywordflow">if</span>(0 == <a class="code hl_variable" href="dcf_receive_8h.html#a5db7e822e50d05412c4701789f4ec79b">countDcf77Messages</a>) <span class="comment">// When no DCF77 message has been received work only on internal clock</span></div>
<div class="line"><span class="lineno">   40</span>        {</div>
<div class="line"><span class="lineno">   41</span>            timeDiff = <a class="code hl_variable" href="time_keeping_8h.html#a0b5f2255718e387332c129faffbc6287">timeOfLastDcfMessage</a> + <a class="code hl_variable" href="time_keeping_8h.html#a0f08c3d1034808ba2b074e526476d23b">timeSinceLastCompleteDcfMessage</a> - <a class="code hl_variable" href="time_keeping_8h.html#a4ca498fffd9c7fc95a918d2c25a23764">mechanicalTimeFloat</a>;</div>
<div class="line"><span class="lineno">   42</span>            P1DIR |= BIT7;                              <span class="comment">// set as output enables indicator LED, indicating clock is off time</span></div>
<div class="line"><span class="lineno">   43</span>        }</div>
<div class="line"><span class="lineno">   44</span>        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code hl_variable" href="dcf_receive_8h.html#a5db7e822e50d05412c4701789f4ec79b">countDcf77Messages</a> &gt; 0) <span class="comment">// One or more DCF77 messages has been received use the time of DCF to set clock</span></div>
<div class="line"><span class="lineno">   45</span>        {</div>
<div class="line"><span class="lineno">   46</span>            <span class="keywordflow">if</span>((<a class="code hl_variable" href="time_keeping_8h.html#a0b5f2255718e387332c129faffbc6287">timeOfLastDcfMessage</a> + <a class="code hl_variable" href="time_keeping_8h.html#a0f08c3d1034808ba2b074e526476d23b">timeSinceLastCompleteDcfMessage</a>) &gt; <a class="code hl_variable" href="time_keeping_8h.html#a4ca498fffd9c7fc95a918d2c25a23764">mechanicalTimeFloat</a>) <span class="comment">// Clock runs behind need to be advanced to current time</span></div>
<div class="line"><span class="lineno">   47</span>            {</div>
<div class="line"><span class="lineno">   48</span>                timeDiff = (<a class="code hl_variable" href="time_keeping_8h.html#a0b5f2255718e387332c129faffbc6287">timeOfLastDcfMessage</a> + <a class="code hl_variable" href="time_keeping_8h.html#a0f08c3d1034808ba2b074e526476d23b">timeSinceLastCompleteDcfMessage</a>) - <a class="code hl_variable" href="time_keeping_8h.html#a4ca498fffd9c7fc95a918d2c25a23764">mechanicalTimeFloat</a>; <span class="comment">// Calculate how much the clock runs behind</span></div>
<div class="line"><span class="lineno">   49</span>            }</div>
<div class="line"><span class="lineno">   50</span>            <span class="keywordflow">else</span> <span class="keywordflow">if</span>((<a class="code hl_variable" href="time_keeping_8h.html#a0b5f2255718e387332c129faffbc6287">timeOfLastDcfMessage</a> + <a class="code hl_variable" href="time_keeping_8h.html#a0f08c3d1034808ba2b074e526476d23b">timeSinceLastCompleteDcfMessage</a>) &lt; <a class="code hl_variable" href="time_keeping_8h.html#a4ca498fffd9c7fc95a918d2c25a23764">mechanicalTimeFloat</a>) <span class="comment">//Clock runs ahead</span></div>
<div class="line"><span class="lineno">   51</span>            {</div>
<div class="line"><span class="lineno">   52</span>                <span class="keywordflow">if</span>((<a class="code hl_variable" href="time_keeping_8h.html#a4ca498fffd9c7fc95a918d2c25a23764">mechanicalTimeFloat</a> - (<a class="code hl_variable" href="time_keeping_8h.html#a0b5f2255718e387332c129faffbc6287">timeOfLastDcfMessage</a> + <a class="code hl_variable" href="time_keeping_8h.html#a0f08c3d1034808ba2b074e526476d23b">timeSinceLastCompleteDcfMessage</a>)) &gt; <a class="code hl_define" href="time_keeping_8h.html#a4e1a1e01c2322782d15bb918cf6e5900">clockWraparoundThresholdSec</a>) <span class="comment">// When the time that the clock runs ahead is greater than the threshold than rotate to 00:00 so it can sync from there</span></div>
<div class="line"><span class="lineno">   53</span>                {</div>
<div class="line"><span class="lineno">   54</span>                    timeDiff = <a class="code hl_define" href="time_keeping_8h.html#a4cda1dd3d8c6b4023200e6a20abea16b">secondsInDay</a> + 60 - <a class="code hl_variable" href="time_keeping_8h.html#a4ca498fffd9c7fc95a918d2c25a23764">mechanicalTimeFloat</a>; <span class="comment">// Calculate the amount of time between clock current state and the time until 00:01</span></div>
<div class="line"><span class="lineno">   55</span>                }</div>
<div class="line"><span class="lineno">   56</span>                <span class="keywordflow">else</span> <span class="keywordflow">if</span>((<a class="code hl_variable" href="time_keeping_8h.html#a4ca498fffd9c7fc95a918d2c25a23764">mechanicalTimeFloat</a> - (<a class="code hl_variable" href="time_keeping_8h.html#a0b5f2255718e387332c129faffbc6287">timeOfLastDcfMessage</a> + <a class="code hl_variable" href="time_keeping_8h.html#a0f08c3d1034808ba2b074e526476d23b">timeSinceLastCompleteDcfMessage</a>)) &lt;= <a class="code hl_define" href="time_keeping_8h.html#a4e1a1e01c2322782d15bb918cf6e5900">clockWraparoundThresholdSec</a>) <span class="comment">// If the time that the clock runs ahead is less or equal to the threshold it is faster to just wait until the clock is on time</span></div>
<div class="line"><span class="lineno">   57</span>                {</div>
<div class="line"><span class="lineno">   58</span>                    timeDiff = 0;</div>
<div class="line"><span class="lineno">   59</span>                }</div>
<div class="line"><span class="lineno">   60</span>                <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno">   61</span>                {</div>
<div class="line"><span class="lineno">   62</span>                    __no_operation(); <span class="comment">//?</span></div>
<div class="line"><span class="lineno">   63</span>                }</div>
<div class="line"><span class="lineno">   64</span>            }</div>
<div class="line"><span class="lineno">   65</span>            <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno">   66</span>            {</div>
<div class="line"><span class="lineno">   67</span>                __no_operation(); <span class="comment">//?</span></div>
<div class="line"><span class="lineno">   68</span>            }</div>
<div class="line"><span class="lineno">   69</span>        }</div>
<div class="line"><span class="lineno">   70</span>        <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno">   71</span>        {</div>
<div class="line"><span class="lineno">   72</span>            __no_operation(); <span class="comment">//?</span></div>
<div class="line"><span class="lineno">   73</span>        }</div>
<div class="line"><span class="lineno">   74</span> </div>
<div class="line"><span class="lineno">   75</span>        <span class="comment">//Checking if calculated time is plausible</span></div>
<div class="line"><span class="lineno">   76</span>        <span class="keywordflow">if</span> (timeDiff &gt; <a class="code hl_define" href="time_keeping_8h.html#a4cda1dd3d8c6b4023200e6a20abea16b">secondsInDay</a>)</div>
<div class="line"><span class="lineno">   77</span>        {</div>
<div class="line"><span class="lineno">   78</span>            __no_operation(); <span class="comment">//Clock will rotate more than a full turn, disable stepper and recalculate</span></div>
<div class="line"><span class="lineno">   79</span>        }</div>
<div class="line"><span class="lineno">   80</span>        <span class="keywordflow">else</span> <span class="comment">// Calculated time is plausible convert to needed steps</span></div>
<div class="line"><span class="lineno">   81</span>        {</div>
<div class="line"><span class="lineno">   82</span>            <span class="keywordflow">if</span> (timeDiff &gt; 60) <span class="comment">// If the time difference is large enough stop receiving dcf messages to prevent crosstalk between stepper and receiver, is enabled again at start of this function</span></div>
<div class="line"><span class="lineno">   83</span>            {</div>
<div class="line"><span class="lineno">   84</span>                <a class="code hl_variable" href="dcf_receive_8h.html#a909b02a38b5db7138462f28eb808d048">toggleInterruptDcf</a> = 0; <span class="comment">// Disable dcfReceive interrupt until clock is done syncing</span></div>
<div class="line"><span class="lineno">   85</span>                P1DIR |= BIT7;                              <span class="comment">// set as output enables indicator LED, indicating clock is off time</span></div>
<div class="line"><span class="lineno">   86</span>                <a class="code hl_variable" href="pin_interrupts_8h.html#a59e3f78f88819165fbb4ceaf21415e23">toggleFwdInterruptISR</a> = 0; <span class="comment">// Disable fwdButton when calculating time and adjusting the clock (enabled again in stepperAdvance function)</span></div>
<div class="line"><span class="lineno">   87</span>                <a class="code hl_variable" href="stepper_advance_8h.html#a4ba7699af83c7cde29945fe93c2c6666">timerCompareStepperSpeedToggle</a> = 1; <span class="comment">//set stepper speed to fast</span></div>
<div class="line"><span class="lineno">   88</span>            }</div>
<div class="line"><span class="lineno">   89</span>            <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno">   90</span>            {</div>
<div class="line"><span class="lineno">   91</span>                <a class="code hl_variable" href="stepper_advance_8h.html#a4ba7699af83c7cde29945fe93c2c6666">timerCompareStepperSpeedToggle</a> = 0; <span class="comment">//set stepper speed to slow</span></div>
<div class="line"><span class="lineno">   92</span>                <span class="keywordflow">if</span> (0 &lt; <a class="code hl_variable" href="dcf_receive_8h.html#a5db7e822e50d05412c4701789f4ec79b">countDcf77Messages</a>)</div>
<div class="line"><span class="lineno">   93</span>                {</div>
<div class="line"><span class="lineno">   94</span>                    P1DIR &amp;= ~BIT7;                              <span class="comment">// set as input disables indicator LED, indicating clock runs on time</span></div>
<div class="line"><span class="lineno">   95</span>                }</div>
<div class="line"><span class="lineno">   96</span>            }</div>
<div class="line"><span class="lineno">   97</span>            <a class="code hl_variable" href="time_keeping_8h.html#a091b76aa72022c5ce648aa66021eb914">stepsRemaining</a> = <a class="code hl_function" href="time_keeping_8h.html#ab81c9ea79bf461d7596a1a89a59e3622">calculateStepsToTake</a>(timeDiff);</div>
<div class="line"><span class="lineno">   98</span><span class="comment">//            #ifdef UART_ENABLED</span></div>
<div class="line"><span class="lineno">   99</span><span class="comment">//                UART_SendInt(timeDiff);</span></div>
<div class="line"><span class="lineno">  100</span><span class="comment">//            #endif</span></div>
<div class="line"><span class="lineno">  101</span> </div>
<div class="line"><span class="lineno">  102</span>            <span class="keywordflow">if</span> (<a class="code hl_variable" href="time_keeping_8h.html#a091b76aa72022c5ce648aa66021eb914">stepsRemaining</a> &gt;= <a class="code hl_define" href="time_keeping_8h.html#ae4f1bd0342086297682a9ea56aab419c">stepsToggleThreshold</a> &amp;&amp; <a class="code hl_variable" href="time_keeping_8h.html#a091b76aa72022c5ce648aa66021eb914">stepsRemaining</a> &lt; <a class="code hl_define" href="time_keeping_8h.html#aac1d439b36ec7656d3c5682583cc11f7">stepsInDay</a>) <span class="comment">//Check if the needed steps to take is larger than the movement threshold, this prevents excessive use of the motor</span></div>
<div class="line"><span class="lineno">  103</span>            {</div>
<div class="line"><span class="lineno">  104</span>                P1OUT |= BIT0;      <span class="comment">//Turn 5v on</span></div>
<div class="line"><span class="lineno">  105</span>                <a class="code hl_variable" href="time_keeping_8h.html#a6f46f3eac7facdb1783cf2d0992be454">toggleCalculateTimeDifference</a> = 0;  <span class="comment">// Disable triggering time difference function in timer interrupt (this function), will be enabled again in stepperAdvance function</span></div>
<div class="line"><span class="lineno">  106</span>                TA0CCTL2 |= CCIE;                   <span class="comment">// TACCR2 interrupt stepperAdvance enable</span></div>
<div class="line"><span class="lineno">  107</span>            }</div>
<div class="line"><span class="lineno">  108</span>        }</div>
<div class="line"><span class="lineno">  109</span>    }</div>
<div class="line"><span class="lineno">  110</span> </div>
<div class="line"><span class="lineno">  111</span><span class="comment">//    if (state) __enable_interrupt(); // Restore previous interrupt state</span></div>
<div class="line"><span class="lineno">  112</span>}</div>
<div class="ttc" id="adcf_receive_8h_html_a5db7e822e50d05412c4701789f4ec79b"><div class="ttname"><a href="dcf_receive_8h.html#a5db7e822e50d05412c4701789f4ec79b">countDcf77Messages</a></div><div class="ttdeci">uint32_t countDcf77Messages</div><div class="ttdef"><b>Definition</b> <a href="dcf_receive_8h_source.html#l00049">dcfReceive.h:49</a></div></div>
<div class="ttc" id="adcf_receive_8h_html_a909b02a38b5db7138462f28eb808d048"><div class="ttname"><a href="dcf_receive_8h.html#a909b02a38b5db7138462f28eb808d048">toggleInterruptDcf</a></div><div class="ttdeci">bool toggleInterruptDcf</div><div class="ttdef"><b>Definition</b> <a href="dcf_receive_8h_source.html#l00024">dcfReceive.h:24</a></div></div>
<div class="ttc" id="apin_interrupts_8h_html_a59e3f78f88819165fbb4ceaf21415e23"><div class="ttname"><a href="pin_interrupts_8h.html#a59e3f78f88819165fbb4ceaf21415e23">toggleFwdInterruptISR</a></div><div class="ttdeci">bool toggleFwdInterruptISR</div><div class="ttdef"><b>Definition</b> <a href="pin_interrupts_8h_source.html#l00012">pinInterrupts.h:12</a></div></div>
<div class="ttc" id="apin_interrupts_8h_html_ab5491185939441dc1d12d58ac2a8ccc2"><div class="ttname"><a href="pin_interrupts_8h.html#ab5491185939441dc1d12d58ac2a8ccc2">toggleFwdInterrupt</a></div><div class="ttdeci">bool toggleFwdInterrupt</div><div class="ttdef"><b>Definition</b> <a href="pin_interrupts_8h_source.html#l00013">pinInterrupts.h:13</a></div></div>
<div class="ttc" id="astepper_advance_8h_html_a4ba7699af83c7cde29945fe93c2c6666"><div class="ttname"><a href="stepper_advance_8h.html#a4ba7699af83c7cde29945fe93c2c6666">timerCompareStepperSpeedToggle</a></div><div class="ttdeci">bool timerCompareStepperSpeedToggle</div><div class="ttdef"><b>Definition</b> <a href="stepper_advance_8h_source.html#l00017">stepperAdvance.h:17</a></div></div>
<div class="ttc" id="atime_keeping_8h_html_a091b76aa72022c5ce648aa66021eb914"><div class="ttname"><a href="time_keeping_8h.html#a091b76aa72022c5ce648aa66021eb914">stepsRemaining</a></div><div class="ttdeci">uint32_t stepsRemaining</div><div class="ttdef"><b>Definition</b> <a href="time_keeping_8h_source.html#l00043">timeKeeping.h:43</a></div></div>
<div class="ttc" id="atime_keeping_8h_html_a0b5f2255718e387332c129faffbc6287"><div class="ttname"><a href="time_keeping_8h.html#a0b5f2255718e387332c129faffbc6287">timeOfLastDcfMessage</a></div><div class="ttdeci">uint32_t timeOfLastDcfMessage</div><div class="ttdef"><b>Definition</b> <a href="time_keeping_8h_source.html#l00021">timeKeeping.h:21</a></div></div>
<div class="ttc" id="atime_keeping_8h_html_a0f08c3d1034808ba2b074e526476d23b"><div class="ttname"><a href="time_keeping_8h.html#a0f08c3d1034808ba2b074e526476d23b">timeSinceLastCompleteDcfMessage</a></div><div class="ttdeci">uint32_t timeSinceLastCompleteDcfMessage</div><div class="ttdef"><b>Definition</b> <a href="time_keeping_8h_source.html#l00022">timeKeeping.h:22</a></div></div>
<div class="ttc" id="atime_keeping_8h_html_a4ca498fffd9c7fc95a918d2c25a23764"><div class="ttname"><a href="time_keeping_8h.html#a4ca498fffd9c7fc95a918d2c25a23764">mechanicalTimeFloat</a></div><div class="ttdeci">double mechanicalTimeFloat</div><div class="ttdef"><b>Definition</b> <a href="time_keeping_8h_source.html#l00040">timeKeeping.h:40</a></div></div>
<div class="ttc" id="atime_keeping_8h_html_a4cda1dd3d8c6b4023200e6a20abea16b"><div class="ttname"><a href="time_keeping_8h.html#a4cda1dd3d8c6b4023200e6a20abea16b">secondsInDay</a></div><div class="ttdeci">#define secondsInDay</div><div class="ttdef"><b>Definition</b> <a href="time_keeping_8h_source.html#l00036">timeKeeping.h:36</a></div></div>
<div class="ttc" id="atime_keeping_8h_html_a4e1a1e01c2322782d15bb918cf6e5900"><div class="ttname"><a href="time_keeping_8h.html#a4e1a1e01c2322782d15bb918cf6e5900">clockWraparoundThresholdSec</a></div><div class="ttdeci">#define clockWraparoundThresholdSec</div><div class="ttdef"><b>Definition</b> <a href="time_keeping_8h_source.html#l00034">timeKeeping.h:34</a></div></div>
<div class="ttc" id="atime_keeping_8h_html_a6f46f3eac7facdb1783cf2d0992be454"><div class="ttname"><a href="time_keeping_8h.html#a6f46f3eac7facdb1783cf2d0992be454">toggleCalculateTimeDifference</a></div><div class="ttdeci">bool toggleCalculateTimeDifference</div><div class="ttdef"><b>Definition</b> <a href="time_keeping_8c_source.html#l00016">timeKeeping.c:16</a></div></div>
<div class="ttc" id="atime_keeping_8h_html_aac1d439b36ec7656d3c5682583cc11f7"><div class="ttname"><a href="time_keeping_8h.html#aac1d439b36ec7656d3c5682583cc11f7">stepsInDay</a></div><div class="ttdeci">#define stepsInDay</div><div class="ttdef"><b>Definition</b> <a href="time_keeping_8h_source.html#l00037">timeKeeping.h:37</a></div></div>
<div class="ttc" id="atime_keeping_8h_html_ab81c9ea79bf461d7596a1a89a59e3622"><div class="ttname"><a href="time_keeping_8h.html#ab81c9ea79bf461d7596a1a89a59e3622">calculateStepsToTake</a></div><div class="ttdeci">uint32_t calculateStepsToTake()</div></div>
<div class="ttc" id="atime_keeping_8h_html_ae4f1bd0342086297682a9ea56aab419c"><div class="ttname"><a href="time_keeping_8h.html#ae4f1bd0342086297682a9ea56aab419c">stepsToggleThreshold</a></div><div class="ttdeci">#define stepsToggleThreshold</div><div class="ttdef"><b>Definition</b> <a href="time_keeping_8h_source.html#l00033">timeKeeping.h:33</a></div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="time_keeping_8h.html#ab81c9ea79bf461d7596a1a89a59e3622">calculateStepsToTake()</a>, <a class="el" href="time_keeping_8h_source.html#l00034">clockWraparoundThresholdSec</a>, <a class="el" href="dcf_receive_8h_source.html#l00049">countDcf77Messages</a>, <a class="el" href="time_keeping_8h_source.html#l00040">mechanicalTimeFloat</a>, <a class="el" href="time_keeping_8h_source.html#l00036">secondsInDay</a>, <a class="el" href="time_keeping_8h_source.html#l00037">stepsInDay</a>, <a class="el" href="time_keeping_8h_source.html#l00043">stepsRemaining</a>, <a class="el" href="time_keeping_8h_source.html#l00033">stepsToggleThreshold</a>, <a class="el" href="time_keeping_8h_source.html#l00021">timeOfLastDcfMessage</a>, <a class="el" href="stepper_advance_8h_source.html#l00017">timerCompareStepperSpeedToggle</a>, <a class="el" href="time_keeping_8h_source.html#l00022">timeSinceLastCompleteDcfMessage</a>, <a class="el" href="time_keeping_8c_source.html#l00016">toggleCalculateTimeDifference</a>, <a class="el" href="pin_interrupts_8h_source.html#l00013">toggleFwdInterrupt</a>, <a class="el" href="pin_interrupts_8h_source.html#l00012">toggleFwdInterruptISR</a>, and <a class="el" href="dcf_receive_8h_source.html#l00024">toggleInterruptDcf</a>.</p>

<p class="reference">Referenced by <a class="el" href="timer_8c_source.html#l00060">ISR_TA0()</a>.</p>

</div>
</div>
<a id="a9e802ca49d23153a19ded7154d8d6895" name="a9e802ca49d23153a19ded7154d8d6895"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9e802ca49d23153a19ded7154d8d6895">&#9670;&#160;</a></span>resetTimeKeeping()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void resetTimeKeeping </td>
          <td>(</td>
          <td class="paramname"><span class="paramname"><em></em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Reset the time settings on startup, gets called from <a class="el" href="main_8c.html#a6288eba0f8e8ad3ab1544ad731eb7667" title="Main function that initializes system components and enters low-power mode.">main()</a> </p>

<p class="definition">Definition at line <a class="el" href="time_keeping_8c_source.html#l00142">142</a> of file <a class="el" href="time_keeping_8c_source.html">timeKeeping.c</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  143</span>{</div>
<div class="line"><span class="lineno">  144</span>    <a class="code hl_variable" href="time_keeping_8h.html#a4ca498fffd9c7fc95a918d2c25a23764">mechanicalTimeFloat</a> = 0.0;</div>
<div class="line"><span class="lineno">  145</span>    <a class="code hl_variable" href="time_keeping_8h.html#a0b5f2255718e387332c129faffbc6287">timeOfLastDcfMessage</a> = 0;</div>
<div class="line"><span class="lineno">  146</span>    <a class="code hl_variable" href="time_keeping_8h.html#a0f08c3d1034808ba2b074e526476d23b">timeSinceLastCompleteDcfMessage</a> = 0;</div>
<div class="line"><span class="lineno">  147</span>}</div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="time_keeping_8h_source.html#l00040">mechanicalTimeFloat</a>, <a class="el" href="time_keeping_8h_source.html#l00021">timeOfLastDcfMessage</a>, and <a class="el" href="time_keeping_8h_source.html#l00022">timeSinceLastCompleteDcfMessage</a>.</p>

<p class="reference">Referenced by <a class="el" href="main_8c_source.html#l00054">main()</a>.</p>

</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="a6f46f3eac7facdb1783cf2d0992be454" name="a6f46f3eac7facdb1783cf2d0992be454"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6f46f3eac7facdb1783cf2d0992be454">&#9670;&#160;</a></span>toggleCalculateTimeDifference</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool toggleCalculateTimeDifference = 1</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="time_keeping_8c_source.html#l00016">16</a> of file <a class="el" href="time_keeping_8c_source.html">timeKeeping.c</a>.</p>

<p class="reference">Referenced by <a class="el" href="time_keeping_8c_source.html#l00026">calculateTimeDifference()</a>, <a class="el" href="timer_8c_source.html#l00060">ISR_TA0()</a>, and <a class="el" href="stepper_advance_8c_source.html#l00023">stepperAdvance()</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_23fdee2f6995db16c755697cdf620cf4.html">Code</a></li><li class="navelem"><a class="el" href="time_keeping_8c.html">timeKeeping.c</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
